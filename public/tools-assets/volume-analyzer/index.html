<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š æ ‡å‡†æˆäº¤é‡åˆ†æå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #e2e8f0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            padding: 2rem;
            line-height: 1.6;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        header::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 4px;
            background: linear-gradient(90deg, transparent, #3b82f6, #8b5cf6, transparent);
            border-radius: 2px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        header p {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 24px rgba(0,0,0,0.3);
        }

        .card h3 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .card .desc {
            color: #64748b;
            font-size: 0.8rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .card h3.blue { color: #60a5fa; }
        .card h3.purple { color: #a78bfa; }
        .card h3.pink { color: #f472b6; }
        .card h3.green { color: #10b981; }

        .file-upload {
            display: block;
            padding: 2rem;
            border: 2px dashed rgba(96, 165, 250, 0.4);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(96, 165, 250, 0.05);
        }

        .file-upload:hover {
            border-color: rgba(96, 165, 250, 0.7);
            background: rgba(96, 165, 250, 0.1);
        }

        .file-upload input {
            display: none;
        }

        .file-upload .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .file-upload .text {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            color: #e2e8f0;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }

        .form-hint {
            display: block;
            color: #64748b;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }

        input[type="number"], select {
            width: 100%;
            padding: 0.6rem 1rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .btn-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            letter-spacing: 0.05em;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn:disabled {
            background: rgba(71, 85, 105, 0.5);
            cursor: not-allowed;
            box-shadow: none;
        }

        .data-info {
            color: #64748b;
            font-size: 0.85rem;
            margin-top: 0.8rem;
        }

        .results {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-container {
            margin-bottom: 1.5rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            padding: 1rem;
            text-align: left;
            color: #94a3b8;
            border-bottom: 2px solid rgba(71, 85, 105, 0.5);
        }

        th:not(:first-child) {
            text-align: right;
        }

        td {
            padding: 0.8rem 1rem;
        }

        td:not(:first-child) {
            text-align: right;
        }

        tr {
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }

        tr:nth-child(even) {
            background: rgba(71, 85, 105, 0.1);
        }

        .positive { color: #10b981; font-weight: 600; }
        .negative { color: #ef4444; font-weight: 600; }
        .neutral { color: #94a3b8; }
        .count { color: #8b5cf6; }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 1.5rem;
            border-top: 1px solid rgba(71, 85, 105, 0.3);
            color: #64748b;
            font-size: 0.85rem;
        }

        footer p:last-child {
            margin-top: 0.5rem;
            opacity: 0.7;
            font-family: 'Consolas', monospace;
        }

        .hidden {
            display: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.8);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.8);
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ“Š æ ‡å‡†æˆäº¤é‡åˆ†æå™¨</h1>
        <p>åˆ†ææˆäº¤é‡å’Œæœªæ¥æ”¶ç›Šçš„å…³ç³»ï¼Œå¯»æ‰¾äº¤æ˜“ä¿¡å·</p>
    </header>

    <div class="controls">
        <div class="card">
            <h3 class="blue">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æ•°æ®</h3>
            <p class="desc">ä¸Šä¼ åŒ…å«è‚¡ç¥¨/æŒ‡æ•°è¡Œæƒ…çš„ CSV æ–‡ä»¶ï¼Œæ–‡ä»¶éœ€è¦æœ‰æˆäº¤é¢å’Œæ”¶ç›˜ä»·æ•°æ®</p>
            <label class="file-upload" id="dropZone">
                <input type="file" id="fileInput" accept=".csv">
                <div class="icon">ğŸ“</div>
                <div class="text" id="fileName">ç‚¹å‡»é€‰æ‹© CSV æ–‡ä»¶</div>
            </label>
        </div>

        <div class="card">
            <h3 class="pink">ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æ•°æ®åˆ—</h3>
            <p class="desc">å‘Šè¯‰ç³»ç»Ÿå“ªä¸€åˆ—æ˜¯æˆäº¤é¢ã€å“ªä¸€åˆ—æ˜¯æ”¶ç›˜ä»·ï¼ˆé€šå¸¸ä¼šè‡ªåŠ¨è¯†åˆ«ï¼‰</p>
            <div class="form-group">
                <label class="form-label">æˆäº¤é¢åœ¨å“ªä¸€åˆ—ï¼Ÿ</label>
                <span class="form-hint">ä¸€èˆ¬å« amountã€æˆäº¤é¢ã€vol ç­‰</span>
                <select id="amountColumn">
                    <option value="">è¯·å…ˆä¸Šä¼ æ–‡ä»¶</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">æ”¶ç›˜ä»·åœ¨å“ªä¸€åˆ—ï¼Ÿ</label>
                <span class="form-hint">ä¸€èˆ¬å« closeã€æ”¶ç›˜ä»·ã€æ”¶ç›˜ ç­‰</span>
                <select id="closeColumn">
                    <option value="">è¯·å…ˆä¸Šä¼ æ–‡ä»¶</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h3 class="purple">ç¬¬ä¸‰æ­¥ï¼šè°ƒæ•´è®¡ç®—æ–¹å¼ï¼ˆå¯é€‰ï¼‰</h3>
            <p class="desc">ä¸€èˆ¬ä¿æŒé»˜è®¤å³å¯ï¼Œæœ‰ç»éªŒçš„ç”¨æˆ·å¯ä»¥è‡ªè¡Œè°ƒæ•´</p>
            <div class="form-group">
                <label class="form-label">ç”¨å¤šå°‘å¤©çš„æ•°æ®è®¡ç®—æ’åï¼Ÿ</label>
                <span class="form-hint">æ¯”å¦‚å¡« 40ï¼Œå°±æ˜¯çœ‹ä»Šå¤©æˆäº¤é‡åœ¨è¿‡å» 40 å¤©é‡Œæ’ç¬¬å‡ </span>
                <input type="number" id="nDays" value="40" min="1" max="500">
            </div>
            <div class="form-group">
                <label class="form-label">é¢„æµ‹æœªæ¥å¤šå°‘å¤©çš„æ”¶ç›Šï¼Ÿ</label>
                <span class="form-hint">æ¯”å¦‚å¡« 5ï¼Œå°±æ˜¯çœ‹ä»Šå¤©ä¹°å…¥ã€5å¤©åå–å‡ºèƒ½èµšå¤šå°‘</span>
                <input type="number" id="futureDays" value="5" min="1" max="100">
            </div>
        </div>
    </div>

    <div class="btn-container">
        <button class="btn" id="analyzeBtn" disabled>ğŸš€ å¼€å§‹åˆ†æ</button>
        <p class="data-info" id="dataInfo"></p>
    </div>

    <div class="results hidden" id="results">
        <div class="card chart-container">
            <h3 class="blue">ğŸ“ˆ åˆ†æç»“æœï¼šæˆäº¤é‡æ’å ä¸ æœªæ¥æ”¶ç›Š çš„å…³ç³»</h3>
            <p class="desc">æŸ±å­è¶Šé«˜è¡¨ç¤ºæ”¶ç›Šè¶Šé«˜ï¼Œç»¿è‰²=èµšé’±ï¼Œçº¢è‰²=äºé’±ã€‚çœ‹çœ‹ä»€ä¹ˆæ ·çš„æˆäº¤é‡æ°´å¹³æ›´å®¹æ˜“èµšé’±ï¼</p>
            <div class="chart-wrapper">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="chart-grid">
            <div class="card">
                <h3 class="purple">ğŸ“Š æ¯ä¸ªæˆäº¤é‡æ°´å¹³æœ‰å¤šå°‘å¤©çš„æ•°æ®</h3>
                <p class="desc">æ ·æœ¬è¶Šå¤šï¼Œç»“æœè¶Šå¯é </p>
                <div class="chart-wrapper">
                    <canvas id="countChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="pink">ğŸ“‰ æ”¶ç›Šè¶‹åŠ¿çº¿</h3>
                <p class="desc">å¯ä»¥æ›´ç›´è§‚åœ°çœ‹å‡ºè¶‹åŠ¿</p>
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 class="green">ğŸ“‹ è¯¦ç»†æ•°æ®è¡¨</h3>
            <p class="desc">
                <strong>æˆäº¤é‡æ’å</strong>ï¼š-1 è¡¨ç¤ºæˆäº¤é‡å¾ˆä½ï¼Œ+1 è¡¨ç¤ºæˆäº¤é‡å¾ˆé«˜ï¼Œ0 è¡¨ç¤ºä¸­ç­‰<br>
                <strong>å¹³å‡æ”¶ç›Š</strong>ï¼šæ­£æ•°è¡¨ç¤ºå¹³å‡èµšé’±ï¼Œè´Ÿæ•°è¡¨ç¤ºå¹³å‡äºé’±
            </p>
            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>æˆäº¤é‡æ’å<br><small style="font-weight:normal;color:#64748b">(-1ä½ ~ +1é«˜)</small></th>
                            <th>å¹³å‡æ”¶ç›Š<br><small style="font-weight:normal;color:#64748b">(æ­£=èµš, è´Ÿ=äº)</small></th>
                            <th>æ ·æœ¬å¤©æ•°<br><small style="font-weight:normal;color:#64748b">(è¶Šå¤šè¶Šå¯é )</small></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        <p>ğŸ’¡ ä½¿ç”¨å»ºè®®ï¼šæ‰¾åˆ°ç»¿è‰²æŸ±å­æœ€é«˜çš„æˆäº¤é‡åŒºé—´ï¼Œå½“æˆäº¤é‡å¤„äºè¯¥åŒºé—´æ—¶è€ƒè™‘ä¹°å…¥</p>
        <p>è®¡ç®—å…¬å¼: æˆäº¤é‡æ’å = 2 Ã— (å½“å‰æ’å - N - 1) / N + 1</p>
    </footer>

    <script>
        let rawData = null;
        let mainChart = null;
        let countChart = null;
        let trendChart = null;

        const fileInput = document.getElementById('fileInput');
        const fileNameEl = document.getElementById('fileName');
        const nDaysInput = document.getElementById('nDays');
        const futureDaysInput = document.getElementById('futureDays');
        const amountColumnSelect = document.getElementById('amountColumn');
        const closeColumnSelect = document.getElementById('closeColumn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const dataInfoEl = document.getElementById('dataInfo');
        const resultsEl = document.getElementById('results');

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            fileNameEl.textContent = 'æ­£åœ¨è¯»å–: ' + file.name;
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'â³ åŠ è½½ä¸­...';

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                    rawData = results.data.filter(row => row && Object.keys(row).length > 0);
                    const columns = Object.keys(rawData[0] || {});

                    populateSelect(amountColumnSelect, columns);
                    populateSelect(closeColumnSelect, columns);

                    autoDetectColumns(columns);

                    fileNameEl.textContent = 'âœ… ' + file.name;
                    dataInfoEl.textContent = `å·²è¯»å– ${rawData.length.toLocaleString()} æ¡æ•°æ®ï¼Œå¯ä»¥å¼€å§‹åˆ†æäº†`;
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'ğŸš€ å¼€å§‹åˆ†æ';
                },
                error: (err) => {
                    console.error('è§£æé”™è¯¯:', err);
                    fileNameEl.textContent = 'âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•';
                    analyzeBtn.textContent = 'ğŸš€ å¼€å§‹åˆ†æ';
                }
            });
        });

        function populateSelect(select, options) {
            select.innerHTML = options.map(opt =>
                `<option value="${opt}">${opt}</option>`
            ).join('');
        }

        function autoDetectColumns(columns) {
            const amtCol = columns.find(c =>
                c.toLowerCase().includes('amount') ||
                c.toLowerCase().includes('vol') ||
                c === 'æˆäº¤é¢' ||
                c === 'æˆäº¤é‡'
            );
            const closeCol = columns.find(c =>
                c.toLowerCase().includes('close') ||
                c === 'æ”¶ç›˜ä»·' ||
                c === 'æ”¶ç›˜'
            );

            if (amtCol) amountColumnSelect.value = amtCol;
            if (closeCol) closeColumnSelect.value = closeCol;
        }

        function calculateRollingRank(data, nDays) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < nDays) {
                    result.push(null);
                } else {
                    const window = data.slice(i - nDays, i + 1);
                    const currentValue = data[i];
                    const rank = window.filter(v => v <= currentValue).length;
                    result.push(rank);
                }
            }
            return result;
        }

        analyzeBtn.addEventListener('click', () => {
            if (!rawData || rawData.length === 0) return;

            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'â³ æ­£åœ¨è®¡ç®—...';

            setTimeout(() => {
                const nDays = parseInt(nDaysInput.value) || 40;
                const futureDays = parseInt(futureDaysInput.value) || 5;
                const amountCol = amountColumnSelect.value;
                const closeCol = closeColumnSelect.value;

                const amounts = rawData.map(row => parseFloat(row[amountCol]) || 0);
                const closes = rawData.map(row => parseFloat(row[closeCol]) || 0);

                const ranks = calculateRollingRank(amounts, nDays);

                const processedData = rawData.map((row, i) => {
                    const rank = ranks[i];
                    const standardRank = rank !== null ?
                        Math.round((2 * (rank - nDays - 1) / nDays + 1) * 100) / 100 : null;
                    const futureClose = i + futureDays < closes.length ? closes[i + futureDays] : null;
                    const futureReturn = futureClose && closes[i] ?
                        (futureClose / closes[i] - 1) * 100 : null;

                    return { standardRank, futureReturn };
                }).filter(row => row.standardRank !== null && row.futureReturn !== null);

                const grouped = {};
                processedData.forEach(row => {
                    const key = row.standardRank;
                    if (!grouped[key]) {
                        grouped[key] = { sum: 0, count: 0 };
                    }
                    grouped[key].sum += row.futureReturn;
                    grouped[key].count += 1;
                });

                const analysisResult = Object.entries(grouped)
                    .map(([key, val]) => ({
                        standardRank: parseFloat(key),
                        avgReturn: Math.round((val.sum / val.count) * 1000) / 1000,
                        count: val.count
                    }))
                    .sort((a, b) => a.standardRank - b.standardRank);

                renderResults(analysisResult, futureDays);

                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ğŸš€ é‡æ–°åˆ†æ';
            }, 50);
        });

        function renderResults(data) {
            resultsEl.classList.remove('hidden');

            const labels = data.map(d => d.standardRank);
            const returns = data.map(d => d.avgReturn);
            const counts = data.map(d => d.count);
            const colors = returns.map(v => v > 0 ? '#10b981' : v < 0 ? '#ef4444' : '#6b7280');

            if (mainChart) mainChart.destroy();
            if (countChart) countChart.destroy();
            if (trendChart) trendChart.destroy();

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(71, 85, 105, 0.3)' },
                        ticks: { color: '#94a3b8', maxTicksLimit: 20 }
                    },
                    y: {
                        grid: { color: 'rgba(71, 85, 105, 0.3)' },
                        ticks: { color: '#94a3b8' }
                    }
                }
            };

            mainChart = new Chart(document.getElementById('mainChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: returns,
                        backgroundColor: colors,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: {
                            ...chartOptions.scales.x,
                            title: { display: true, text: 'æˆäº¤é‡æ’åï¼ˆ-1=å¾ˆä½, 0=ä¸­ç­‰, +1=å¾ˆé«˜ï¼‰', color: '#94a3b8' }
                        },
                        y: {
                            ...chartOptions.scales.y,
                            title: { display: true, text: 'å¹³å‡æ”¶ç›Š %ï¼ˆæ­£=èµšé’±, è´Ÿ=äºé’±ï¼‰', color: '#94a3b8' }
                        }
                    }
                }
            });

            countChart = new Chart(document.getElementById('countChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 4
                    }]
                },
                options: chartOptions
            });

            trendChart = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: returns,
                        borderColor: '#f472b6',
                        backgroundColor: 'rgba(244, 114, 182, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#f472b6',
                        pointRadius: 4,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: chartOptions
            });

            const tbody = document.querySelector('#resultTable tbody');
            tbody.innerHTML = data.map(row => {
                const returnClass = row.avgReturn > 0 ? 'positive' : row.avgReturn < 0 ? 'negative' : 'neutral';
                const sign = row.avgReturn > 0 ? '+' : '';
                return `
                    <tr>
                        <td>${row.standardRank}</td>
                        <td class="${returnClass}">${sign}${row.avgReturn}%</td>
                        <td class="count">${row.count.toLocaleString()} å¤©</td>
                    </tr>
                `;
            }).join('');

            resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
